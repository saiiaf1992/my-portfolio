<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Options PNL Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        canvas {
            max-width: 300px;
            max-height: 300px;
        }
        .charts {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Options PNL Tracker</h1>

    <div>
        <label for="fileInput">Import Trades CSV:</label>
        <input type="file" id="fileInput" accept=".csv" />
    </div>

    <div class="charts">
        <div>
            <h3>Total PNL</h3>
            <canvas id="pnlPie"></canvas>
        </div>
        <div>
            <h3>Win vs Loss</h3>
            <canvas id="winLossPie"></canvas>
        </div>
    </div>

    <h3>Weekly PNL</h3>
    <canvas id="weeklyPNLChart"></canvas>

    <h3>Trades Calendar</h3>
    <table id="calendarTable"></table>

    <script>
        const fileInput = document.getElementById("fileInput");
        const calendarTable = document.getElementById("calendarTable");

        fileInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split("\n").slice(1);
                const trades = lines.map(line => {
                    const cols = line.split(',');
                    return {
                        symbol: cols[1],
                        side: cols[2],
                        status: cols[3],
                        qty: parseInt(cols[4]),
                        price: parseFloat(cols[6].replace('@', '')),
                        time: new Date(cols[10])
                    };
                }).filter(trade => trade.status === 'Filled' && !isNaN(trade.price));

                localStorage.setItem("trades", JSON.stringify(trades));
                renderCharts(trades);
                renderCalendar(trades);
                renderWeeklyPNL(trades);
            };
            reader.readAsText(file);
        });

        function renderCharts(trades) {
            let totalPNL = 0, wins = 0, losses = 0;
            const positionMap = new Map();

            for (const trade of trades) {
                const key = trade.symbol;
                if (!positionMap.has(key)) positionMap.set(key, []);
                positionMap.get(key).push(trade);
            }

            positionMap.forEach((tradeList) => {
                let netQty = 0, avgCost = 0, pnl = 0;
                tradeList.forEach((t) => {
                    if (t.side === "Buy") {
                        avgCost = (avgCost * netQty + t.price * t.qty) / (netQty + t.qty);
                        netQty += t.qty;
                    } else if (t.side === "Sell") {
                        pnl += (t.price - avgCost) * t.qty;
                        netQty -= t.qty;
                    }
                });
                totalPNL += pnl;
                if (pnl > 0) wins++;
                else if (pnl < 0) losses++;
            });

            new Chart(document.getElementById("pnlPie"), {
                type: "pie",
                data: {
                    labels: ["PNL"],
                    datasets: [{ data: [totalPNL], backgroundColor: ["#4caf50"] }]
                }
            });

            new Chart(document.getElementById("winLossPie"), {
                type: "pie",
                data: {
                    labels: ["Wins", "Losses"],
                    datasets: [{
                        data: [wins, losses],
                        backgroundColor: ["#2196f3", "#f44336"]
                    }]
                }
            });
        }

        function renderWeeklyPNL(trades) {
            const weeklyPNL = {};

            trades.forEach(t => {
                const date = new Date(t.time);
                const weekKey = `${date.getFullYear()}-W${getWeekNumber(date)}`;
                if (!weeklyPNL[weekKey]) weeklyPNL[weekKey] = { buys: [], sells: [] };
                if (t.side === "Buy") weeklyPNL[weekKey].buys.push(t);
                if (t.side === "Sell") weeklyPNL[weekKey].sells.push(t);
            });

            const labels = [], data = [];
            for (const [week, { buys, sells }] of Object.entries(weeklyPNL)) {
                let netQty = 0, avg = 0, pnl = 0;
                buys.forEach(b => {
                    avg = (avg * netQty + b.price * b.qty) / (netQty + b.qty);
                    netQty += b.qty;
                });
                sells.forEach(s => {
                    pnl += (s.price - avg) * s.qty;
                    netQty -= s.qty;
                });
                labels.push(week);
                data.push(pnl);
            }

            new Chart(document.getElementById("weeklyPNLChart"), {
                type: "bar",
                data: {
                    labels,
                    datasets: [{
                        label: "Weekly PNL",
                        data,
                        backgroundColor: "#ff9800"
                    }]
                }
            });
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function renderCalendar(trades) {
            const dateMap = {};
            trades.forEach(t => {
                const date = t.time.toISOString().split('T')[0];
                if (!dateMap[date]) dateMap[date] = [];
                dateMap[date].push(t);
            });

            const dates = Object.keys(dateMap).sort();
            calendarTable.innerHTML = '<tr><th>Date</th><th>Trades</th></tr>';
            dates.forEach(date => {
                const count = dateMap[date].length;
                calendarTable.innerHTML += `<tr><td>${date}</td><td>${count} trade(s)</td></tr>`;
            });
        }
    </script>
</body>
</html>
