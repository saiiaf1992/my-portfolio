<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Options PNL Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .chart-container { display: flex; gap: 20px; flex-wrap: wrap; }
    canvas { width: 200px !important; height: 200px !important; }
    #tradesTable { margin-top: 20px; width: 100%; border-collapse: collapse; }
    #tradesTable th, #tradesTable td { border: 1px solid #ccc; padding: 5px; }
  </style>
</head>
<body>
  <h1>Options PNL Tracker</h1>

  <input type="file" id="csvInput" accept=".csv" />
  <button onclick="exportCSV()">Export Trades</button>

  <div class="chart-container">
    <div>
      <h3>PNL Chart</h3>
      <canvas id="pnlChart"></canvas>
    </div>
    <div>
      <h3>Win/Loss Chart</h3>
      <canvas id="winLossChart"></canvas>
    </div>
  </div>

  <table id="tradesTable"></table>

  <script>
    const pnlCtx = document.getElementById('pnlChart').getContext('2d');
    const winLossCtx = document.getElementById('winLossChart').getContext('2d');

    let pnlChart, winLossChart;

    document.getElementById('csvInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      Papa.parse(file, {
        header: true,
        complete: function (results) {
          const trades = results.data.filter(row => row.Status === "Filled");
          localStorage.setItem('trades', JSON.stringify(trades));
          alert('Trades imported successfully!');
          displayTrades(trades);
          updateCharts(trades);
        }
      });
    });

    function exportCSV() {
      const trades = JSON.parse(localStorage.getItem('trades') || '[]');
      const csv = Papa.unparse(trades);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'my_trades.csv');
      link.click();
    }

    function displayTrades(trades) {
      const table = document.getElementById('tradesTable');
      table.innerHTML = '';
      if (!trades.length) return;
      const headers = Object.keys(trades[0]);
      let html = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
      trades.forEach(t => {
        html += '<tr>' + headers.map(h => `<td>${t[h]}</td>`).join('') + '</tr>';
      });
      table.innerHTML = html;
    }

    function updateCharts(trades) {
      let profit = 0, loss = 0, wins = 0, losses = 0;
      trades.forEach(t => {
        const side = t.Side;
        const qty = parseFloat(t['Total Qty'] || 0);
        const price = parseFloat(t.Price || 0);
        const avg = parseFloat(t['Avg Price'] || 0);

        const pnl = side === 'Buy' ? (avg - price) * qty : (price - avg) * qty;
        if (pnl > 0) {
          profit += pnl;
          wins++;
        } else {
          loss += Math.abs(pnl);
          losses++;
        }
      });

      if (pnlChart) pnlChart.destroy();
      pnlChart = new Chart(pnlCtx, {
        type: 'pie',
        data: {
          labels: ['Profit', 'Loss'],
          datasets: [{
            data: [profit, loss],
            backgroundColor: ['green', 'red']
          }]
        }
      });

      if (winLossChart) winLossChart.destroy();
      winLossChart = new Chart(winLossCtx, {
        type: 'pie',
        data: {
          labels: ['Wins', 'Losses'],
          datasets: [{
            data: [wins, losses],
            backgroundColor: ['blue', 'orange']
          }]
        }
      });
    }

    // Load trades on refresh
    const saved = JSON.parse(localStorage.getItem('trades') || '[]');
    if (saved.length) {
      displayTrades(saved);
      updateCharts(saved);
    }
  </script>
</body>
</html>
